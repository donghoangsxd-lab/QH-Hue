<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Quy hoạch Huế</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin:0; height:100vh; display:flex; flex-direction:column; font-family:sans-serif; }
    #layout { flex:1; display:grid; grid-template-rows: 1fr auto; }
    #top { display:grid; grid-template-columns: 1fr 0fr; height:100%; transition: all 0.3s; }
    #map { background:#ddd; }
    #chart { background:#f9f9f9; display:none; padding:10px; }
    #table { background:#fff; display:none; height:33vh; overflow:auto; }
    #summary { padding:5px; font-weight:bold; background:#f0f0f0; }

    /* Nút mũi tên */
    .toggle-btn {
      position:fixed;
      width:0; height:0;
      cursor:pointer;
      z-index:999;
    }
    /* Mũi tên dưới (bảng) */
    #btnTable {
      bottom:10px; left:50%; transform:translateX(-50%);
      border-left:10px solid transparent;
      border-right:10px solid transparent;
    }
    /* Mũi tên phải (biểu đồ) */
    #btnChart {
      top:50%; right:5px; transform:translateY(-50%);
      border-top:10px solid transparent;
      border-bottom:10px solid transparent;
    }
    /* Màu trắng + viền xám */
    .arrow-white {
      border-color:white;
      outline:2px solid gray;
    }
  </style>
</head>
<body>
  <div id="layout">
    <div id="top">
      <div id="map"></div>
      <div id="chart"><canvas id="chartCanvas"></canvas></div>
    </div>
    <div id="table">
      <table id="qhTable" class="display" style="width:100%"></table>
      <div id="summary">Tổng diện tích: 0 ha | Tổng dân số: 0 người</div>
    </div>
  </div>

  <!-- Nút mũi tên -->
  <div id="btnTable" class="toggle-btn"></div>
  <div id="btnChart" class="toggle-btn"></div>

<script>
  // Bản đồ
  var map = L.map('map').setView([16.466, 107.579], 13);
  L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3']
  }).addTo(map);

  // Dữ liệu bảng
  const qhData = [
    ["QH001","Quy hoạch Phú Xuân","123/QĐ-UBND","01/01/2024","UBND tỉnh",4300,310000],
    ["QH002","Quy hoạch Thuận Hóa","456/QĐ-UBND","15/03/2024","UBND tỉnh",6600,410000]
  ];
  const table = $('#qhTable').DataTable({
    data: qhData,
    columns: [
      { title: "Mã đồ án" },
      { title: "Tên đồ án" },
      { title: "Quyết định" },
      { title: "Ngày ban hành" },
      { title: "Cơ quan ban hành" },
      { title: "Diện tích (ha)" },
      { title: "Dân số (người)" }
    ]
  });

  // Tổng
  function updateSummary(maList) {
    let tongDienTich = 0, tongDanSo = 0;
    maList.forEach(ma => {
      const row = qhData.find(r => r[0] === ma);
      if (row) {
        tongDienTich += parseFloat(row[5]);
        tongDanSo += parseInt(row[6]);
      }
    });
    document.getElementById('summary').innerText =
      `Tổng diện tích: ${tongDienTich.toLocaleString()} ha | Tổng dân số: ${tongDanSo.toLocaleString()} người`;
  }

  // Polygon
  let selectedLayers = [];
  fetch('data.geojson')
    .then(res => res.json())
    .then(geojsonData => {
      L.geoJSON(geojsonData, {
        style: f => ({
          color: f.properties.stroke,
          fillColor: f.properties.fill,
          fillOpacity: 0.5,
          weight: 1.2
        }),
        onEachFeature: (f, layer) => {
          layer.on('click', e => {
            const isShift = e.originalEvent.shiftKey;
            if (!isShift) {
              selectedLayers.forEach(l => l.setStyle({
                color: l.feature.properties.stroke,
                fillColor: l.feature.properties.fill,
                fillOpacity: l.feature.properties['fill-opacity'],
                weight: 1.2
              }));
              selectedLayers = [layer];
            } else {
              if (!selectedLayers.includes(layer)) selectedLayers.push(layer);
            }
            selectedLayers.forEach(l => l.setStyle({
              color: '#FFFFFF',
              weight: 3,
              fillColor: l.feature.properties.fill,
              fillOpacity: l.feature.properties['fill-opacity']
            }));
            const maList = selectedLayers.map(l => l.feature.properties.name);
            table.search(maList.join('|'), true, false).draw();
            updateSummary(maList);
          });
        }
      }).addTo(map);
    });

  // Biểu đồ
  new Chart(document.getElementById('chartCanvas').getContext('2d'), {
    type: 'bar',
    data: {
      labels: ['Phú Xuân','Thuận Hóa'],
      datasets: [{
        label: 'Dân số',
        data: [310000,410000],
        backgroundColor: ['green','red']
      }]
    }
  });

  // Điều khiển bố cục
  let showTable = false, showChart = false;
  function updateLayout() {
    const tableDiv = document.getElementById('table');
    const chartDiv = document.getElementById('chart');
    const top = document.getElementById('top');
    const btnTable = document.getElementById('btnTable');
    const btnChart = document.getElementById('btnChart');

    tableDiv.style.display = showTable ? 'block' : 'none';
    chartDiv.style.display = showChart ? 'block' : 'none';

    if (showTable && showChart) {
      top.style.gridTemplateColumns = '3fr 1fr'; // map 3/4, chart 1/4
      top.style.height = '67vh';
      tableDiv.style.height = '33vh';
      // mũi tên hướng ra cạnh
      btnTable.style.borderTop = "10px solid white";
      btnTable.style.borderLeft = "10px solid transparent";
      btnTable.style.borderRight = "10px solid transparent";
      btnTable.style.outline = "2px solid gray";
      btnChart.style.borderRight = "10px solid white";
      btnChart.style.borderTop = "10px solid transparent";
      btnChart.style.borderBottom = "10px solid transparent";
      btnChart.style.outline = "2px solid gray";
    } else if (showChart && !showTable) {
      top.style.gridTemplateColumns = '3fr 1fr';
      top.style.height = '100vh';
      // mũi tên hướng ra cạnh
      btnTable.style.borderTop = "10px solid white";
      btnTable.style.borderLeft = "10px solid transparent";
      btnTable.style.borderRight = "10px solid transparent";
      btnTable.style.outline = "2px solid gray";

      btnChart.style.borderRight = "10px solid white";
      btnChart.style.borderTop = "10px solid transparent";
      btnChart.style.borderBottom = "10px solid transparent";
      btnChart.style.outline = "2px solid gray";
    } else if (!showChart && showTable) {
      top.style.gridTemplateColumns = '1fr 0fr';
      top.style.height = '67vh';
      tableDiv.style.height = '33vh';
      // mũi tên hướng ra cạnh
      btnTable.style.borderTop = "10px solid white";
      btnTable.style.borderLeft = "10px solid transparent";
      btnTable.style.borderRight = "10px solid transparent";
      btnTable.style.outline = "2px solid gray";

      btnChart.style.borderLeft = "10px solid white";
      btnChart.style.borderTop = "10px solid transparent";
      btnChart.style.borderBottom = "10px solid transparent";
      btnChart.style.outline = "2px solid gray";
    } else {
      top.style.gridTemplateColumns = '1fr 0fr';
      top.style.height = '100vh';
      tableDiv.style.height = '0';
      // mũi tên hướng vào trong (bảng/biểu tắt)
      btnTable.style.borderBottom = "10px solid white";
      btnTable.style.borderLeft = "10px solid transparent";
      btnTable.style.borderRight = "10px solid transparent";
      btnTable.style.outline = "2px solid gray";

      btnChart.style.borderLeft = "10px solid white";
      btnChart.style.borderTop = "10px solid transparent";
      btnChart.style.borderBottom = "10px solid transparent";
      btnChart.style.outline = "2px solid gray";
    }
  }

  document.getElementById('btnTable').onclick = () => {
    showTable = !showTable;
    updateLayout();
  };
  document.getElementById('btnChart').onclick = () => {
    showChart = !showChart;
    updateLayout();
  };

  // Khởi tạo layout ban đầu
  updateLayout();
